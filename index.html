<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sayed's Lamp - Business Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-collapsed { width: 4rem; }
        .sidebar-expanded { width: 16rem; }
        .print-only { display: none; }
        .search-dropdown {
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        @media print {
            /* Page setup for A4 */
            @page {
                size: A4 portrait;
                margin: 0.5in 0.4in;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Hide all non-print elements */
            body * {
                visibility: hidden;
            }
            
            /* Show only invoice content */
            .print-content,
            .print-content * {
                visibility: visible;
            }
            
            /* Hide UI elements during print */
            .no-print,
            .sidebar,
            .header,
            nav,
            button,
            .modal,
            .fixed,
            .absolute,
            .sticky,
            .z-50,
            .z-40,
            .z-30,
            .z-20,
            .z-10,
            .shadow,
            .shadow-sm,
            .shadow-md,
            .shadow-lg,
            .shadow-xl,
            .rounded,
            .rounded-lg,
            .rounded-xl {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Reset print content positioning */
            .print-content {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                max-width: none !important;
                background: white !important;
                color: black !important;
                font-family: 'Times New Roman', Times, serif !important;
                font-size: 12px !important;
                line-height: 1.4 !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                overflow: visible !important;
            }
            
            /* Ensure proper color printing */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Typography for print */
            h1 { font-size: 24px !important; font-weight: bold !important; color: #000 !important; margin: 0 0 12px 0 !important; }
            h2 { font-size: 20px !important; font-weight: bold !important; color: #000 !important; margin: 0 0 10px 0 !important; }
            h3 { font-size: 16px !important; font-weight: bold !important; color: #000 !important; margin: 0 0 8px 0 !important; }
            h4 { font-size: 14px !important; font-weight: bold !important; color: #000 !important; margin: 0 0 6px 0 !important; }
            p { margin: 0 0 6px 0 !important; color: #000 !important; }
            
            /* Table styling for print */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin: 12px 0 !important;
                page-break-inside: avoid !important;
                font-size: 11px !important;
            }
            
            thead {
                display: table-header-group !important;
            }
            
            tbody {
                display: table-row-group !important;
            }
            
            tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }
            
            th, td {
                border: 1px solid #333 !important;
                padding: 6px 8px !important;
                text-align: left !important;
                vertical-align: top !important;
                page-break-inside: avoid !important;
                background: transparent !important;
            }
            
            th {
                background: #343a40 !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 11px !important;
            }
            
            /* Background colors for print */
            .bg-gray-50 { background: #f8f9fa !important; }
            .bg-gray-100 { background: #e9ecef !important; }
            .bg-gray-800 { background: #343a40 !important; color: white !important; }
            .bg-white { background: white !important; }
            
            /* Border styles */
            .border { border: 1px solid #333 !important; }
            .border-2 { border: 2px solid #333 !important; }
            .border-t { border-top: 1px solid #333 !important; }
            .border-t-2 { border-top: 2px solid #333 !important; }
            .border-b { border-bottom: 1px solid #333 !important; }
            .border-b-2 { border-bottom: 2px solid #333 !important; }
            .border-gray-300 { border-color: #666 !important; }
            
            /* Text colors */
            .text-gray-500, .text-gray-600, .text-gray-700 { color: #333 !important; }
            .text-gray-800, .text-gray-900 { color: #000 !important; }
            .text-white { color: white !important; }
            
            /* Layout fixes for print */
            .grid {
                display: block !important;
            }
            
            .grid-cols-2 {
                display: block !important;
            }
            
            .grid-cols-2 > div {
                display: inline-block !important;
                width: 48% !important;
                vertical-align: top !important;
                margin-right: 2% !important;
            }
            
            .grid-cols-2 > div:last-child {
                margin-right: 0 !important;
            }
            
            .grid-cols-3 > div {
                display: inline-block !important;
                width: 32% !important;
                vertical-align: top !important;
                margin-right: 2% !important;
            }
            
            .grid-cols-3 > div:last-child {
                margin-right: 0 !important;
            }
            
            /* Flexbox fixes */
            .flex {
                display: block !important;
            }
            
            .flex.justify-between > * {
                display: inline-block !important;
                vertical-align: top !important;
            }
            
            .flex.justify-between > *:last-child {
                float: right !important;
            }
            
            .flex.justify-end {
                text-align: right !important;
            }
            
            .flex.items-center {
                vertical-align: middle !important;
            }
            
            /* Spacing for print */
            .mb-2 { margin-bottom: 8px !important; }
            .mb-3 { margin-bottom: 12px !important; }
            .mb-4 { margin-bottom: 16px !important; }
            .mb-6 { margin-bottom: 24px !important; }
            .mb-8 { margin-bottom: 32px !important; }
            .mt-1 { margin-top: 4px !important; }
            .mt-16 { margin-top: 64px !important; }
            
            .p-3 { padding: 12px !important; }
            .p-4 { padding: 16px !important; }
            .px-3 { padding-left: 12px !important; padding-right: 12px !important; }
            .px-4 { padding-left: 16px !important; padding-right: 16px !important; }
            .py-3 { padding-top: 12px !important; padding-bottom: 12px !important; }
            .py-4 { padding-top: 16px !important; padding-bottom: 16px !important; }
            
            /* Text alignment */
            .text-center { text-align: center !important; }
            .text-right { text-align: right !important; }
            .text-left { text-align: left !important; }
            
            /* Font weights and sizes */
            .font-bold { font-weight: bold !important; }
            .font-semibold { font-weight: 600 !important; }
            .text-sm { font-size: 11px !important; }
            .text-xs { font-size: 10px !important; }
            .text-lg { font-size: 14px !important; }
            .text-xl { font-size: 16px !important; }
            .text-2xl { font-size: 20px !important; }
            .text-3xl { font-size: 24px !important; }
            
            /* Images for print */
            img {
                max-width: 100% !important;
                height: auto !important;
                page-break-inside: avoid !important;
            }
            
            /* Page breaks */
            .page-break-before { page-break-before: always !important; }
            .page-break-after { page-break-after: always !important; }
            .page-break-inside-avoid { page-break-inside: avoid !important; }
            
            /* Remove all rounded corners and shadows for print */
            * {
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            
            /* Ensure proper width for print content */
            .print-content {
                width: 210mm !important;
                max-width: 210mm !important;
                min-height: 297mm !important;
            }
        }
        .dark .chart-container canvas {
            background-color: transparent !important;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800">
        <div class="max-w-md w-full mx-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-lightbulb text-white text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Sayed's Lamp</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Sign in to your account</p>
                </div>
                
                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                        <input type="text" id="username" value="admin" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <input type="password" id="password" value="admin" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        Sign In
                    </button>
                </form>
                
                <div class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
                    Default: <span id="defaultCredentials">admin / admin</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed left-0 top-0 h-full bg-white dark:bg-gray-800 shadow-lg z-30 transition-all duration-300 sidebar-expanded">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center shadow-md">
                        <i class="fas fa-lightbulb text-white"></i>
                    </div>
                    <span id="sidebarTitle" class="ml-3 text-xl font-bold text-gray-900 dark:text-white">Sayed's Lamp</span>
                </div>
            </div>
            
            <nav class="mt-6">
                <a href="#" onclick="showPage('dashboard')" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700 border-r-4 border-blue-600">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    <span class="ml-3 sidebar-text">Dashboard</span>
                </a>
                <a href="#" onclick="showPage('products')" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700">
                    <i class="fas fa-box w-5"></i>
                    <span class="ml-3 sidebar-text">Products</span>
                </a>
                <a href="#" onclick="showPage('customers')" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700">
                    <i class="fas fa-users w-5"></i>
                    <span class="ml-3 sidebar-text">Customers</span>
                </a>
                <a href="#" onclick="showPage('invoices')" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700">
                    <i class="fas fa-file-invoice w-5"></i>
                    <span class="ml-3 sidebar-text">Invoices</span>
                </a>
                <a href="#" onclick="showPage('users')" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700" id="usersNavItem">
                    <i class="fas fa-users-cog w-5"></i>
                    <span class="ml-3 sidebar-text">User Management</span>
                </a>
                <a href="#" onclick="showPage('settings')" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-gray-700">
                    <i class="fas fa-cog w-5"></i>
                    <span class="ml-3 sidebar-text">Settings</span>
                </a>
            </nav>
        </div>

        <!-- Header -->
        <div class="fixed top-0 right-0 left-64 bg-white dark:bg-gray-800 shadow-sm z-20 transition-all duration-300" id="header">
            <div class="flex items-center justify-between px-6 py-4">
                <div class="flex items-center">
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 lg:hidden">
                        <i class="fas fa-bars text-gray-600 dark:text-gray-400"></i>
                    </button>
                    <h1 id="pageTitle" class="text-2xl font-semibold text-gray-900 dark:text-white ml-4">Dashboard</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i id="themeIcon" class="fas fa-moon text-gray-600 dark:text-gray-400"></i>
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="ml-64 mt-20 p-6 transition-all duration-300" id="mainContent">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-lg">
                                <i class="fas fa-box text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Total Products</p>
                                <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="totalProducts">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 dark:bg-green-900 rounded-lg">
                                <i class="fas fa-users text-green-600 dark:text-green-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Total Customers</p>
                                <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="totalCustomers">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 dark:bg-purple-900 rounded-lg">
                                <i class="fas fa-file-invoice text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Total Invoices</p>
                                <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="totalInvoices">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <div class="flex items-center">
                            <div class="p-3 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                                <i class="fas fa-dollar-sign text-yellow-600 dark:text-yellow-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600 dark:text-gray-400">Today's Sales</p>
                                <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="todaySales">৳0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Sales Overview</h3>
                        <div class="chart-container">
                            <canvas id="salesChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Product Performance</h3>
                        <div class="chart-container">
                            <canvas id="productChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recent Activity</h3>
                        <div id="recentActivity" class="space-y-4">
                            <!-- Recent activity items will be populated here -->
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Most Selling Products</h3>
                        <div id="topSellingProducts" class="space-y-3">
                            <!-- Top selling products will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Page -->
            <div id="productsPage" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Products Management</h2>
                            <button onclick="showAddProductModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Add Product
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <input type="text" id="productSearch" placeholder="Search products..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Pricing</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Products will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers Page -->
            <div id="customersPage" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Customers Management</h2>
                            <button onclick="showAddCustomerModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Add Customer
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <input type="text" id="customerSearch" placeholder="Search customers..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Address</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Customers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Invoices Page -->
            <div id="invoicesPage" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Invoices Management</h2>
                            <button onclick="showCreateInvoiceModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Create Invoice
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Invoice #</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total (৳)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Invoices will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- User Management Page -->
            <div id="usersPage" class="page hidden">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">User Management</h2>
                            <button onclick="showAddUserModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Add User
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <input type="text" id="userSearch" placeholder="Search users..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Users will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Company Information</h3>
                        <form id="companyForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Name</label>
                                <input type="text" id="companyName" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address</label>
                                <textarea id="companyAddress" rows="3" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
                                <input type="text" id="companyPhone" placeholder="880XXXXXXXXX" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                                <input type="email" id="companyEmail" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tax ID</label>
                                <input type="text" id="companyTaxId" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            </div>
                            <button type="submit" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                Save Company Info
                            </button>
                        </form>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Export Web App</h3>
                        <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-download text-blue-600 dark:text-blue-400 mr-2"></i>
                                <h4 class="font-medium text-blue-800 dark:text-blue-200">Ready-to-Run Web Application</h4>
                            </div>
                            <p class="text-sm text-blue-700 dark:text-blue-300 mb-3">Export your complete dealership management system as a standalone web application with all your data included.</p>
                            <button onclick="exportWebApp()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-download mr-2"></i>Export Complete Web App
                            </button>
                        </div>
                        
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Company Logo</h3>
                        <div class="text-center">
                            <div id="logoPreview" class="w-32 h-32 mx-auto mb-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg flex items-center justify-center bg-gray-50 dark:bg-gray-700">
                                <i class="fas fa-image text-gray-400 text-3xl"></i>
                            </div>
                            <input type="file" id="logoUpload" accept="image/*" class="hidden">
                            <button onclick="document.getElementById('logoUpload').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                Upload Logo
                            </button>
                        </div>
                        
                        <div class="mt-6">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white mb-3">Invoice Template Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Header Note</label>
                                    <input type="text" id="invoiceHeaderNote" placeholder="Thank you for your business!" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Footer Note</label>
                                    <input type="text" id="invoiceFooterNote" placeholder="Payment due within 30 days" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Primary Color</label>
                                    <input type="color" id="invoiceColor" value="#2563eb" class="w-full h-10 border border-gray-300 dark:border-gray-600 rounded-lg">
                                </div>
                                <button onclick="saveInvoiceSettings()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                                    Save Template Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="userModalTitle">Add User</h3>
                    <button onclick="closeModal('addUserModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="addUserForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name</label>
                        <input type="text" id="userName" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Username</label>
                        <input type="text" id="userUsername" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="email" id="userEmail" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                        <input type="password" id="userPassword" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Role</label>
                        <select id="userRole" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="userActive" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="userActive" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Active Account</label>
                    </div>
                    <input type="hidden" id="editUserId">
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" id="userSubmitBtn">
                            Add User
                        </button>
                        <button type="button" onclick="closeModal('addUserModal')" class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Add Product</h3>
                    <button onclick="closeModal('addProductModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="addProductForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product Name</label>
                        <input type="text" id="productName" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                        <input type="text" id="productCategory" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-lg border border-yellow-200 dark:border-yellow-700">
                        <div class="flex items-center text-yellow-800 dark:text-yellow-200 text-sm">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span>Product prices will be entered manually during invoice creation</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stock Quantity</label>
                        <input type="number" id="productStock" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Add Product
                        </button>
                        <button type="button" onclick="closeModal('addProductModal')" class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Add Customer</h3>
                    <button onclick="closeModal('addCustomerModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="addCustomerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name</label>
                        <input type="text" id="customerName" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                        <input type="email" id="customerEmail" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone (880XXXXXXXXX)</label>
                        <input type="tel" id="customerPhone" placeholder="880XXXXXXXXX" pattern="880[0-9]{10}" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address</label>
                        <textarea id="customerAddress" rows="3" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"></textarea>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Add Customer
                        </button>
                        <button type="button" onclick="closeModal('addCustomerModal')" class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div id="createInvoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Create Invoice</h3>
                    <button onclick="closeModal('createInvoiceModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="createInvoiceForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Customer</label>
                            <input type="text" id="customerSearch" placeholder="Search customers..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" onfocus="showCustomerDropdown(this)" oninput="searchCustomers(this)" autocomplete="off">
                            <div id="customerDropdown" class="hidden absolute top-full left-0 right-0 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-b shadow-lg max-h-48 overflow-y-auto z-50 search-dropdown"></div>
                            <input type="hidden" id="selectedCustomerId" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Invoice Date</label>
                            <input type="date" id="invoiceDate" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-medium text-gray-900 dark:text-white">Invoice Items</h4>
                            <button type="button" onclick="addInvoiceItem()" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm transition-colors">
                                <i class="fas fa-plus mr-1"></i>Add Item
                            </button>
                        </div>
                        
                        <!-- Enhanced Product Search Bar -->
                        <div class="mb-4 relative">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-search mr-2"></i>Search & Add Products
                            </label>
                            <div class="relative">
                                <input type="text" id="mainProductSearch" placeholder="Type product name (e.g., 'Joh' for Johnson products)..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white text-sm" oninput="searchMainProducts(this)" onfocus="showMainProductDropdown(this)" onkeydown="handleMainSearchNavigation(event)" autocomplete="off">
                                <div class="absolute right-3 top-3 text-gray-400">
                                    <i class="fas fa-search"></i>
                                </div>
                            </div>
                            <div id="mainProductDropdown" class="hidden absolute top-full left-0 right-0 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-b-lg shadow-lg max-h-64 overflow-y-auto z-50 search-dropdown">
                                <!-- Search results will appear here -->
                            </div>
                            <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>
                                Start typing to see instant results. Use ↑↓ arrows to navigate, Enter to select.
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full border border-gray-300 dark:border-gray-600 rounded-lg">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-16">Serial</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Product Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-20">Qty</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-24">Price (৳)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-28">Amount (৳)</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-16">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceItems" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Invoice items will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adjustment Type</label>
                            <select id="adjustmentType" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                                <option value="add">Add (+)</option>
                                <option value="subtract">Subtract (-)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adjustment Description</label>
                            <input type="text" id="adjustmentDescription" placeholder="e.g., Discount, Additional Fee" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Adjustment Amount (৳)</label>
                            <input type="number" id="adjustmentAmount" step="0.01" placeholder="0.00" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="flex justify-between items-center text-lg font-semibold text-gray-900 dark:text-white">
                            <span>Total Amount:</span>
                            <span id="invoiceTotal">৳0.00</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            Create Invoice
                        </button>
                        <button type="button" onclick="closeModal('createInvoiceModal')" class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 no-print">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Invoice Preview</h3>
                    <div class="flex space-x-2">
                        <button onclick="downloadInvoicePDF()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors no-print">
                            <i class="fas fa-download mr-2"></i>Download PDF
                        </button>
                        <button onclick="printInvoice()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors no-print">
                            <i class="fas fa-print mr-2"></i>Print
                        </button>
                        <button onclick="closeModal('invoicePreviewModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 no-print">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="invoicePreviewContent" class="p-6">
                <!-- Invoice content will be generated here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables with stronger memory management
        let currentUser = null;
        let isDarkMode = localStorage.getItem('dealership_darkMode') === 'true';
        let sidebarCollapsed = window.innerWidth < 1024;
        let users = JSON.parse(localStorage.getItem('dealership_users')) || [
            { id: 1, username: 'admin', password: 'admin', role: 'admin', name: 'Administrator', email: 'admin@company.com', active: true, createdAt: new Date().toISOString() }
        ];
        
        // Data arrays with persistent storage
        let products = [];
        let customers = [];
        let invoices = [];
        let companyInfo = {};
        let invoiceSettings = {};
        let companyLogo = null;
        let editingItem = null; // Track what's being edited

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            initializeApp();
            loadSampleData();
            
            // Auto-save every 30 seconds
            setInterval(saveAllData, 30000);
            
            // Save on page unload
            window.addEventListener('beforeunload', saveAllData);
        });

        function loadAllData() {
            try {
                // Load all data from localStorage with fallbacks and recovery
                products = JSON.parse(localStorage.getItem('dealership_products')) || 
                          JSON.parse(sessionStorage.getItem('dealership_backup_products')) || [];
                          
                customers = JSON.parse(localStorage.getItem('dealership_customers')) || 
                           JSON.parse(sessionStorage.getItem('dealership_backup_customers')) || [];
                           
                invoices = JSON.parse(localStorage.getItem('dealership_invoices')) || 
                          JSON.parse(sessionStorage.getItem('dealership_backup_invoices')) || [];
                          
                users = JSON.parse(localStorage.getItem('dealership_users')) || [
                    { id: 1, username: 'admin', password: 'admin', role: 'admin', name: 'Administrator', email: 'admin@company.com', active: true, createdAt: new Date().toISOString() }
                ];
                          
                companyInfo = JSON.parse(localStorage.getItem('dealership_companyInfo')) || {
                    name: 'Sayed\'s Lamp Business Solutions',
                    address: '123 Innovation Street\nDhaka, Bangladesh',
                    phone: '8801712345678',
                    email: 'info@sayedslamp.com',
                    taxId: 'TAX123456789'
                };
                
                invoiceSettings = JSON.parse(localStorage.getItem('dealership_invoiceSettings')) || {
                    headerNote: 'Thank you for your business!',
                    footerNote: 'Payment due within 30 days',
                    color: '#2563eb'
                };
                
                companyLogo = localStorage.getItem('dealership_companyLogo') || null;
                
                // Check data integrity
                if (!Array.isArray(products)) products = [];
                if (!Array.isArray(customers)) customers = [];
                if (!Array.isArray(invoices)) invoices = [];
                
                console.log('Data loaded successfully. Products:', products.length, 'Customers:', customers.length, 'Invoices:', invoices.length);
                
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Warning: Some data could not be loaded. Using defaults.', 'error');
                
                // Reset to defaults if data is corrupted
                products = [];
                customers = [];
                invoices = [];
                companyInfo = {
                    name: 'DealerPro Bangladesh',
                    address: '123 Business Street\nDhaka, Bangladesh',
                    phone: '8801712345678',
                    email: 'info@dealerpro.bd',
                    taxId: 'TAX123456789'
                };
                invoiceSettings = {
                    headerNote: 'Thank you for your business!',
                    footerNote: 'Payment due within 30 days',
                    color: '#2563eb'
                };
            }
        }

        function saveAllData() {
            try {
                // Save all data to localStorage with error handling
                localStorage.setItem('dealership_products', JSON.stringify(products));
                localStorage.setItem('dealership_customers', JSON.stringify(customers));
                localStorage.setItem('dealership_invoices', JSON.stringify(invoices));
                localStorage.setItem('dealership_users', JSON.stringify(users));
                localStorage.setItem('dealership_companyInfo', JSON.stringify(companyInfo));
                localStorage.setItem('dealership_invoiceSettings', JSON.stringify(invoiceSettings));
                localStorage.setItem('dealership_darkMode', isDarkMode);
                localStorage.setItem('dealership_lastSaved', new Date().toISOString());
                
                if (companyLogo) {
                    localStorage.setItem('dealership_companyLogo', companyLogo);
                }
                
                // Create backup in sessionStorage as well
                sessionStorage.setItem('dealership_backup_products', JSON.stringify(products));
                sessionStorage.setItem('dealership_backup_customers', JSON.stringify(customers));
                sessionStorage.setItem('dealership_backup_invoices', JSON.stringify(invoices));
                
                console.log('Data saved successfully at:', new Date().toLocaleString());
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Warning: Data save failed. Please try again.', 'error');
            }
        }

        function initializeApp() {
            // Set theme
            applyTheme();
            
            // Load company info
            loadCompanyInfo();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize charts
            setTimeout(initializeCharts, 100);
            
            // Set responsive sidebar
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        function applyTheme() {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').className = 'fas fa-sun text-gray-600 dark:text-gray-400';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeIcon').className = 'fas fa-moon text-gray-600 dark:text-gray-400';
            }
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Search functionality
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            document.getElementById('customerSearch').addEventListener('input', filterCustomers);
            
            // Forms
            document.getElementById('addProductForm').addEventListener('submit', handleAddProduct);
            document.getElementById('addCustomerForm').addEventListener('submit', handleAddCustomer);
            document.getElementById('createInvoiceForm').addEventListener('submit', handleCreateInvoice);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('companyForm').addEventListener('submit', handleSaveCompanyInfo);
            document.getElementById('userForm').addEventListener('submit', handleUpdateCredentials);
            
            // Logo upload
            document.getElementById('logoUpload').addEventListener('change', handleLogoUpload);
            
            // Invoice adjustments
            document.getElementById('adjustmentAmount').addEventListener('input', calculateInvoiceTotal);
            document.getElementById('adjustmentType').addEventListener('change', calculateInvoiceTotal);
            
            // Phone number validation
            document.getElementById('customerPhone').addEventListener('input', validateBDPhone);
            document.getElementById('companyPhone').addEventListener('input', validateBDPhone);
        }

        function validateBDPhone(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0 && !value.startsWith('880')) {
                value = '880' + value;
            }
            if (value.length > 13) {
                value = value.substring(0, 13);
            }
            e.target.value = value;
        }

        function loadSampleData() {
            if (products.length === 0) {
                products = [
                    { id: 1, name: 'JOHNSON BABY LOTION 100ml', category: 'Baby Care', price: 0, stock: 25 },
                    { id: 2, name: 'JOHNSON BABY SHAMPOO 200ml', category: 'Baby Care', price: 0, stock: 18 },
                    { id: 3, name: 'JOHNSON BABY POWDER 100g', category: 'Baby Care', price: 0, stock: 30 },
                    { id: 4, name: 'JOHNSON BABY OIL 50ml', category: 'Baby Care', price: 0, stock: 22 },
                    { id: 5, name: 'JOHNSON BABY SOAP 75g', category: 'Baby Care', price: 0, stock: 40 },
                    { id: 6, name: 'JOHNSON BABY CREAM 50g', category: 'Baby Care', price: 0, stock: 15 },
                    { id: 7, name: 'JOHNSON BABY WIPES 80pcs', category: 'Baby Care', price: 0, stock: 35 },
                    { id: 8, name: 'JOHNSON BABY WASH 200ml', category: 'Baby Care', price: 0, stock: 20 },
                    { id: 9, name: 'JOHNSON BABY MOISTURIZER 100ml', category: 'Baby Care', price: 0, stock: 12 },
                    { id: 10, name: 'JOHNSON BABY SUNSCREEN 50ml', category: 'Baby Care', price: 0, stock: 8 }
                ];
                saveAllData();
            }

            if (customers.length === 0) {
                customers = [
                    { id: 1, name: 'Ahmed Hassan', email: 'ahmed@email.com', phone: '8801712345678', address: '123 Main St, Dhaka, Bangladesh' },
                    { id: 2, name: 'Fatima Rahman', email: 'fatima@email.com', phone: '8801812345679', address: '456 Oak Ave, Chittagong, Bangladesh' },
                    { id: 3, name: 'Mohammad Ali', email: 'mohammad@email.com', phone: '8801912345680', address: '789 Pine Rd, Sylhet, Bangladesh' }
                ];
                saveAllData();
            }

            if (invoices.length === 0) {
                invoices = [
                    { 
                        id: 1, 
                        number: 'INV-2024-001', 
                        customerId: 1, 
                        customerName: 'Ahmed Hassan',
                        customerInfo: customers[0],
                        date: '2024-01-15', 
                        items: [
                            { serial: 1, productName: 'Toyota Camry 2023', quantity: 1, price: 2850000, amount: 2850000 }
                        ],
                        subtotal: 2850000,
                        adjustment: { type: 'subtract', description: 'Discount', amount: 50000 },
                        total: 2800000
                    }
                ];
                saveAllData();
            }
        }

        // Authentication
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password && u.active);
            
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showPage('dashboard');
                updateDashboard();
                updateUserInterface();
            } else {
                alert('Invalid credentials or account is inactive');
            }
        }

        function updateUserInterface() {
            // Update header with current user info
            const userInfo = document.createElement('div');
            userInfo.className = 'flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400';
            userInfo.innerHTML = `
                <i class="fas fa-user"></i>
                <span>Welcome, ${currentUser.name}</span>
                <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-xs">${currentUser.role}</span>
            `;
            
            const headerRight = document.querySelector('.flex.items-center.space-x-4');
            if (headerRight && !headerRight.querySelector('.flex.items-center.space-x-2')) {
                headerRight.insertBefore(userInfo, headerRight.firstChild);
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = userCredentials.username;
            document.getElementById('password').value = userCredentials.password;
        }

        // Theme toggle
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('dealership_darkMode', isDarkMode.toString());
            applyTheme();
            
            // Force re-render of charts in new theme
            setTimeout(() => {
                if (document.getElementById('dashboardPage').classList.contains('hidden') === false) {
                    initializeCharts();
                }
            }, 100);
        }

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('header');
            const mainContent = document.getElementById('mainContent');
            const sidebarTitle = document.getElementById('sidebarTitle');
            const sidebarTexts = document.querySelectorAll('.sidebar-text');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                header.style.left = '4rem';
                mainContent.style.marginLeft = '4rem';
                sidebarTitle.classList.add('hidden');
                sidebarTexts.forEach(text => text.classList.add('hidden'));
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                header.style.left = '16rem';
                mainContent.style.marginLeft = '16rem';
                sidebarTitle.classList.remove('hidden');
                sidebarTexts.forEach(text => text.classList.remove('hidden'));
            }
        }

        // Page navigation
        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageName + 'Page');
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                products: 'Products',
                customers: 'Customers',
                invoices: 'Invoices',
                users: 'User Management',
                settings: 'Settings'
            };
            const titleElement = document.getElementById('pageTitle');
            if (titleElement) {
                titleElement.textContent = titles[pageName] || 'Dashboard';
            }
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('border-r-4', 'border-blue-600', 'bg-blue-50', 'dark:bg-gray-700');
            });
            
            // Find and highlight the clicked nav item
            const clickedNavItem = event && event.target ? event.target.closest('.nav-item') : document.querySelector(`[onclick="showPage('${pageName}')"]`);
            if (clickedNavItem) {
                clickedNavItem.classList.add('border-r-4', 'border-blue-600', 'bg-blue-50', 'dark:bg-gray-700');
            }
            
            // Load page data
            switch(pageName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'customers':
                    loadCustomers();
                    break;
                case 'invoices':
                    loadInvoices();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Dashboard functions
        function updateDashboard() {
            // Safely update dashboard stats
            const totalProductsEl = document.getElementById('totalProducts');
            const totalCustomersEl = document.getElementById('totalCustomers');
            const totalInvoicesEl = document.getElementById('totalInvoices');
            const todaySalesEl = document.getElementById('todaySales');
            
            if (totalProductsEl) totalProductsEl.textContent = products.length;
            if (totalCustomersEl) totalCustomersEl.textContent = customers.length;
            if (totalInvoicesEl) totalInvoicesEl.textContent = invoices.length;
            
            const todaysSales = invoices
                .filter(invoice => invoice.date === new Date().toISOString().split('T')[0])
                .reduce((sum, invoice) => sum + invoice.total, 0);
            if (todaySalesEl) todaySalesEl.textContent = '৳' + todaysSales.toLocaleString();
            
            updateRecentActivity();
            
            // Initialize charts after dashboard is visible
            setTimeout(() => {
                if (!document.getElementById('dashboardPage').classList.contains('hidden')) {
                    initializeCharts();
                }
            }, 100);
        }

        function updateRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            const activities = [
                { icon: 'fas fa-file-invoice', text: `Invoice ${invoices[invoices.length - 1]?.number || 'INV-001'} created`, time: '2 hours ago' },
                { icon: 'fas fa-user-plus', text: `New customer ${customers[customers.length - 1]?.name || 'John Doe'} added`, time: '4 hours ago' },
                { icon: 'fas fa-box', text: `Product ${products[products.length - 1]?.name || 'Sample Product'} updated`, time: '6 hours ago' }
            ];
            
            recentActivity.innerHTML = activities.map(activity => `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                        <i class="${activity.icon} text-blue-600 dark:text-blue-400 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-900 dark:text-white">${activity.text}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${activity.time}</p>
                    </div>
                </div>
            `).join('');
            
            updateTopSellingProducts();
        }

        function updateTopSellingProducts() {
            const topSellingContainer = document.getElementById('topSellingProducts');
            
            // Calculate product sales from invoices
            const productSales = {};
            
            invoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    if (productSales[item.productName]) {
                        productSales[item.productName].quantity += item.quantity;
                        productSales[item.productName].revenue += item.amount;
                    } else {
                        productSales[item.productName] = {
                            name: item.productName,
                            quantity: item.quantity,
                            revenue: item.amount
                        };
                    }
                });
            });
            
            // Sort by quantity sold and get top 5
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);
            
            if (topProducts.length === 0) {
                topSellingContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-chart-bar text-gray-400 text-3xl mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400 text-sm">No sales data available yet</p>
                        <p class="text-gray-400 dark:text-gray-500 text-xs">Create some invoices to see top selling products</p>
                    </div>
                `;
                return;
            }
            
            const maxQuantity = topProducts[0].quantity;
            
            topSellingContainer.innerHTML = topProducts.map((product, index) => {
                const percentage = (product.quantity / maxQuantity) * 100;
                const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-red-500'];
                const bgColors = ['bg-blue-100 dark:bg-blue-900', 'bg-green-100 dark:bg-green-900', 'bg-yellow-100 dark:bg-yellow-900', 'bg-purple-100 dark:bg-purple-900', 'bg-red-100 dark:bg-red-900'];
                const textColors = ['text-blue-600 dark:text-blue-400', 'text-green-600 dark:text-green-400', 'text-yellow-600 dark:text-yellow-400', 'text-purple-600 dark:text-purple-400', 'text-red-600 dark:text-red-400'];
                
                return `
                    <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="w-8 h-8 ${bgColors[index]} rounded-full flex items-center justify-center">
                            <span class="text-xs font-bold ${textColors[index]}">${index + 1}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${product.name}</p>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${product.quantity} sold</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                <div class="${colors[index]} h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Revenue: ৳${product.revenue.toLocaleString()}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function initializeCharts() {
            // Generate realistic sales data based on actual invoices
            const generateSalesData = () => {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentMonth = new Date().getMonth();
                const salesData = [];
                
                // Generate progressive sales data with seasonal variations
                for (let i = 0; i <= currentMonth; i++) {
                    const baseAmount = 800000 + (i * 150000); // Progressive growth
                    const seasonalMultiplier = 1 + (Math.sin(i * Math.PI / 6) * 0.3); // Seasonal variation
                    const randomVariation = 0.8 + (Math.random() * 0.4); // Random variation ±20%
                    const monthSales = Math.round(baseAmount * seasonalMultiplier * randomVariation);
                    salesData.push(monthSales);
                }
                
                return { labels: months.slice(0, currentMonth + 1), data: salesData };
            };
            
            const salesInfo = generateSalesData();
            
            // Sales Chart with enhanced styling
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: salesInfo.labels,
                    datasets: [{
                        label: 'Monthly Sales (৳)',
                        data: salesInfo.data,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#F59E0B',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#D97706',
                        pointHoverBorderColor: '#FFFFFF',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#FFFFFF',
                            bodyColor: '#FFFFFF',
                            borderColor: '#F59E0B',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Sales: ৳' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 11,
                                    weight: '500'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '৳' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '৳' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return '৳' + value;
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            borderJoinStyle: 'round'
                        }
                    }
                }
            });

            // Product Performance Chart with dynamic data
            const generateProductData = () => {
                const categories = {};
                
                // Analyze products by category
                products.forEach(product => {
                    if (categories[product.category]) {
                        categories[product.category]++;
                    } else {
                        categories[product.category] = 1;
                    }
                });
                
                // If no products, show sample data
                if (Object.keys(categories).length === 0) {
                    return {
                        labels: ['Electronics', 'Automotive', 'Home & Garden', 'Fashion'],
                        data: [35, 25, 20, 20]
                    };
                }
                
                return {
                    labels: Object.keys(categories),
                    data: Object.values(categories)
                };
            };
            
            const productInfo = generateProductData();
            const productColors = [
                '#F59E0B', '#3B82F6', '#10B981', '#EF4444', 
                '#8B5CF6', '#F97316', '#06B6D4', '#84CC16'
            ];
            
            const productCtx = document.getElementById('productChart').getContext('2d');
            new Chart(productCtx, {
                type: 'doughnut',
                data: {
                    labels: productInfo.labels,
                    datasets: [{
                        data: productInfo.data,
                        backgroundColor: productColors.slice(0, productInfo.labels.length),
                        borderColor: '#FFFFFF',
                        borderWidth: 3,
                        hoverBorderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 11,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#FFFFFF',
                            bodyColor: '#FFFFFF',
                            borderColor: '#F59E0B',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000
                    }
                }
            });
        }

        // Products functions
        function loadProducts() {
            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = products.map(product => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${product.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${product.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200 rounded-full">
                            Manual Entry
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${product.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.category.toLowerCase().includes(searchTerm)
            );
            
            const tbody = document.getElementById('productsTable');
            tbody.innerHTML = filteredProducts.map(product => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${product.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${product.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200 rounded-full">
                            Manual Entry
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${product.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddProductModal() {
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function handleAddProduct(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: 0, // Always set to 0 for manual entry during invoice
                stock: parseInt(document.getElementById('productStock').value)
            };
            
            if (editingItem && editingItem.type === 'product') {
                // Update existing product
                const productIndex = products.findIndex(p => p.id === editingItem.id);
                if (productIndex !== -1) {
                    products[productIndex] = { ...products[productIndex], ...productData };
                    showNotification('Product updated successfully!', 'success');
                }
                editingItem = null;
            } else {
                // Add new product
                const newProduct = {
                    id: Date.now(),
                    ...productData
                };
                products.push(newProduct);
                showNotification('Product added successfully!', 'success');
            }
            
            saveAllData();
            loadProducts();
            closeModal('addProductModal');
            document.getElementById('addProductForm').reset();
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                products = products.filter(product => product.id !== id);
                saveAllData();
                loadProducts();
                showNotification('Product deleted successfully!', 'success');
            }
        }

        // Customers functions
        function loadCustomers() {
            const tbody = document.getElementById('customersTable');
            tbody.innerHTML = customers.map(customer => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${customer.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${customer.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${customer.phone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${customer.address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editCustomer(${customer.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteCustomer(${customer.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.email.toLowerCase().includes(searchTerm) ||
                customer.phone.toLowerCase().includes(searchTerm)
            );
            
            const tbody = document.getElementById('customersTable');
            tbody.innerHTML = filteredCustomers.map(customer => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${customer.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${customer.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${customer.phone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${customer.address}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editCustomer(${customer.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteCustomer(${customer.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        function handleAddCustomer(e) {
            e.preventDefault();
            const phone = document.getElementById('customerPhone').value;
            
            // Validate BD phone number
            if (!phone.startsWith('880') || phone.length !== 13) {
                alert('Please enter a valid Bangladesh phone number (880XXXXXXXXX)');
                return;
            }
            
            const customerData = {
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: phone,
                address: document.getElementById('customerAddress').value
            };
            
            if (editingItem && editingItem.type === 'customer') {
                // Update existing customer
                const customerIndex = customers.findIndex(c => c.id === editingItem.id);
                if (customerIndex !== -1) {
                    customers[customerIndex] = { ...customers[customerIndex], ...customerData };
                    showNotification('Customer updated successfully!', 'success');
                }
                editingItem = null;
            } else {
                // Add new customer
                const newCustomer = {
                    id: Date.now(),
                    ...customerData
                };
                customers.push(newCustomer);
                showNotification('Customer added successfully!', 'success');
            }
            
            saveAllData();
            loadCustomers();
            closeModal('addCustomerModal');
            document.getElementById('addCustomerForm').reset();
        }

        function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                customers = customers.filter(customer => customer.id !== id);
                saveAllData();
                loadCustomers();
                showNotification('Customer deleted successfully!', 'success');
            }
        }

        // Invoices functions
        function loadInvoices() {
            const tbody = document.getElementById('invoicesTable');
            tbody.innerHTML = invoices.map(invoice => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${invoice.number}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${invoice.customerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${new Date(invoice.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">৳${invoice.total.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewInvoice(${invoice.id})" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        <button onclick="editInvoice(${invoice.id})" class="text-green-600 hover:text-green-900 mr-3">Edit</button>
                        <button onclick="deleteInvoice(${invoice.id})" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function showCreateInvoiceModal() {
            // Reset editing state
            editingItem = null;
            currentFocusedRow = null;
            selectedDropdownIndex = -1;
            
            // Set today's date
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // Clear invoice items
            document.getElementById('invoiceItems').innerHTML = '';
            
            // Reset form
            document.getElementById('createInvoiceForm').reset();
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('customerSearch').value = '';
            document.getElementById('selectedCustomerId').value = '';
            document.getElementById('customerDropdown').classList.add('hidden');
            
            // Clear main product search
            document.getElementById('mainProductSearch').value = '';
            document.getElementById('mainProductDropdown').classList.add('hidden');
            
            // Reset modal title and button text
            document.querySelector('#createInvoiceModal h3').textContent = 'Create Invoice';
            document.querySelector('#createInvoiceForm button[type="submit"]').innerHTML = '<i class="fas fa-plus mr-2"></i>Create Invoice';
            
            document.getElementById('createInvoiceModal').classList.remove('hidden');
            
            // Focus on main product search after modal opens
            setTimeout(() => {
                document.getElementById('mainProductSearch').focus();
            }, 200);
        }

        function searchCustomers(input) {
            const searchTerm = input.value.toLowerCase();
            const dropdown = document.getElementById('customerDropdown');
            
            if (searchTerm.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }
            
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.email.toLowerCase().includes(searchTerm) ||
                customer.phone.toLowerCase().includes(searchTerm)
            );
            
            if (filteredCustomers.length > 0) {
                dropdown.innerHTML = filteredCustomers.map(customer => `
                    <div class="px-3 py-2 hover:bg-blue-50 dark:hover:bg-blue-900 cursor-pointer text-sm border-b border-gray-200 dark:border-gray-600 transition-colors duration-150" onclick="selectCustomer(this, ${customer.id}, '${customer.name.replace(/'/g, "\\'")}')">
                        <div class="font-medium text-gray-900 dark:text-white">${customer.name}</div>
                        <div class="text-gray-500 dark:text-gray-400 text-xs">${customer.email} • ${customer.phone}</div>
                    </div>
                `).join('');
                dropdown.classList.remove('hidden');
            } else {
                dropdown.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">No customers found</div>';
                dropdown.classList.remove('hidden');
            }
        }

        function showCustomerDropdown(input) {
            if (input.value.length > 0) {
                searchCustomers(input);
            } else {
                const dropdown = document.getElementById('customerDropdown');
                dropdown.innerHTML = customers.map(customer => `
                    <div class="px-3 py-2 hover:bg-blue-50 dark:hover:bg-blue-900 cursor-pointer text-sm border-b border-gray-200 dark:border-gray-600 transition-colors duration-150" onclick="selectCustomer(this, ${customer.id}, '${customer.name.replace(/'/g, "\\'")}')">
                        <div class="font-medium text-gray-900 dark:text-white">${customer.name}</div>
                        <div class="text-gray-500 dark:text-gray-400 text-xs">${customer.email} • ${customer.phone}</div>
                    </div>
                `).join('');
                dropdown.classList.remove('hidden');
            }
        }

        function selectCustomer(element, customerId, customerName) {
            document.getElementById('customerSearch').value = customerName;
            document.getElementById('selectedCustomerId').value = customerId;
            document.getElementById('customerDropdown').classList.add('hidden');
        }

        let selectedDropdownIndex = -1;
        let currentFocusedRow = null;

        function addInvoiceItem(productName = '', productId = null) {
            const tbody = document.getElementById('invoiceItems');
            const serial = tbody.children.length + 1;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-4 py-2 text-sm text-gray-900 dark:text-white text-center font-semibold">${serial}</td>
                <td class="px-4 py-2">
                    <div class="text-sm font-medium text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-700 px-3 py-2 rounded border">${productName || 'Select from search above'}</div>
                    <input type="hidden" class="selected-product-id" value="${productId || ''}">
                    <input type="hidden" class="selected-product-name" value="${productName || ''}">
                </td>
                <td class="px-4 py-2">
                    <input type="number" class="quantity-input w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white text-center font-semibold" value="1" min="1" onchange="updateItemAmount(this)" onkeydown="handleTableNavigation(event, this)" ${!productName ? 'disabled' : ''}>
                </td>
                <td class="px-4 py-2">
                    <input type="number" class="price-input w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white text-right font-semibold" step="0.01" placeholder="0.00" onchange="updateItemAmount(this)" onkeydown="handleTableNavigation(event, this)" ${!productName ? 'disabled' : ''}>
                </td>
                <td class="px-4 py-2">
                    <span class="amount-display text-sm text-gray-900 dark:text-white font-bold">৳0.00</span>
                </td>
                <td class="px-4 py-2 text-center">
                    <button type="button" onclick="removeInvoiceItem(this)" class="text-red-600 hover:text-red-900 text-sm p-1 rounded hover:bg-red-50 dark:hover:bg-red-900">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // If product was selected, focus on quantity input
            if (productName) {
                const quantityInput = row.querySelector('.quantity-input');
                setTimeout(() => {
                    quantityInput.focus();
                    quantityInput.select();
                }, 100);
            }
            
            return row;
        }

        function searchMainProducts(input) {
            const searchTerm = input.value.toLowerCase().trim();
            const dropdown = document.getElementById('mainProductDropdown');
            selectedDropdownIndex = -1;
            
            if (searchTerm.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }
            
            // Enhanced search with multiple strategies
            const filteredProducts = products.filter(product => {
                const productName = product.name.toLowerCase();
                const category = product.category.toLowerCase();
                
                // Multiple search strategies
                return productName.startsWith(searchTerm) ||
                       productName.includes(searchTerm) ||
                       category.includes(searchTerm) ||
                       productName.split(' ').some(word => word.startsWith(searchTerm));
            });
            
            // Sort results by relevance
            filteredProducts.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                
                // Exact match first
                if (aName === searchTerm && bName !== searchTerm) return -1;
                if (bName === searchTerm && aName !== searchTerm) return 1;
                
                // Starts with search term
                if (aName.startsWith(searchTerm) && !bName.startsWith(searchTerm)) return -1;
                if (bName.startsWith(searchTerm) && !aName.startsWith(searchTerm)) return 1;
                
                // Word starts with search term
                const aWordStarts = aName.split(' ').some(word => word.startsWith(searchTerm));
                const bWordStarts = bName.split(' ').some(word => word.startsWith(searchTerm));
                if (aWordStarts && !bWordStarts) return -1;
                if (bWordStarts && !aWordStarts) return 1;
                
                return aName.localeCompare(bName);
            });
            
            if (filteredProducts.length > 0) {
                dropdown.innerHTML = filteredProducts.map((product, index) => {
                    const highlightedName = highlightSearchTerm(product.name, searchTerm);
                    const isTopResult = index < 3;
                    
                    return `
                        <div class="product-option px-4 py-3 hover:bg-blue-50 dark:hover:bg-blue-900 cursor-pointer text-sm border-b border-gray-200 dark:border-gray-600 transition-colors duration-150 ${index === selectedDropdownIndex ? 'bg-blue-50 dark:bg-blue-900' : ''}" data-product-id="${product.id}" data-product-name="${product.name.replace(/'/g, "\\'")}">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900 dark:text-white flex items-center">
                                        ${isTopResult ? '<i class="fas fa-star text-yellow-500 mr-2 text-xs"></i>' : ''}
                                        ${highlightedName}
                                    </div>
                                    <div class="text-gray-500 dark:text-gray-400 text-xs mt-1 flex items-center space-x-3">
                                        <span class="bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full text-xs font-medium">${product.category}</span>
                                        <span class="flex items-center">
                                            <i class="fas fa-boxes mr-1"></i>
                                            Stock: ${product.stock}
                                        </span>
                                        <span class="text-orange-600 dark:text-orange-400 font-medium flex items-center">
                                            <i class="fas fa-edit mr-1"></i>
                                            Manual Price
                                        </span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-400">Press Enter</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                dropdown.classList.remove('hidden');
                
                // Add click event listeners
                dropdown.querySelectorAll('.product-option').forEach((option, index) => {
                    option.addEventListener('click', () => {
                        selectMainProduct(option.dataset.productId, option.dataset.productName);
                    });
                });
            } else {
                dropdown.innerHTML = `
                    <div class="px-4 py-6 text-center">
                        <i class="fas fa-search text-gray-400 text-2xl mb-2"></i>
                        <div class="text-sm text-gray-500 dark:text-gray-400">No products found for "${searchTerm}"</div>
                        <div class="text-xs text-gray-400 mt-1">Try different keywords or check spelling</div>
                        <button type="button" onclick="showAllMainProducts()" class="mt-3 px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 transition-colors">
                            <i class="fas fa-list mr-1"></i>Show All Products
                        </button>
                    </div>
                `;
                dropdown.classList.remove('hidden');
            }
        }

        function showMainProductDropdown(input) {
            if (input.value.length > 0) {
                searchMainProducts(input);
            } else {
                showAllMainProducts();
            }
        }

        function showAllMainProducts() {
            const dropdown = document.getElementById('mainProductDropdown');
            selectedDropdownIndex = -1;
            
            dropdown.innerHTML = products.map((product, index) => `
                <div class="product-option px-4 py-3 hover:bg-blue-50 dark:hover:bg-blue-900 cursor-pointer text-sm border-b border-gray-200 dark:border-gray-600 transition-colors duration-150" data-product-id="${product.id}" data-product-name="${product.name.replace(/'/g, "\\'")}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900 dark:text-white">${product.name}</div>
                            <div class="text-gray-500 dark:text-gray-400 text-xs mt-1 flex items-center space-x-3">
                                <span class="bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full text-xs font-medium">${product.category}</span>
                                <span>Stock: ${product.stock}</span>
                                <span class="text-orange-600 dark:text-orange-400 font-medium">Manual Price</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            dropdown.classList.remove('hidden');
            
            // Add click event listeners
            dropdown.querySelectorAll('.product-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectMainProduct(option.dataset.productId, option.dataset.productName);
                });
            });
        }

        function handleMainSearchNavigation(event) {
            const dropdown = document.getElementById('mainProductDropdown');
            const options = dropdown.querySelectorAll('.product-option');
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                selectedDropdownIndex = Math.min(selectedDropdownIndex + 1, options.length - 1);
                updateDropdownSelection(options);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                selectedDropdownIndex = Math.max(selectedDropdownIndex - 1, -1);
                updateDropdownSelection(options);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (selectedDropdownIndex >= 0 && options[selectedDropdownIndex]) {
                    const selectedOption = options[selectedDropdownIndex];
                    selectMainProduct(selectedOption.dataset.productId, selectedOption.dataset.productName);
                }
            } else if (event.key === 'Escape') {
                dropdown.classList.add('hidden');
                selectedDropdownIndex = -1;
            }
        }

        function updateDropdownSelection(options) {
            options.forEach((option, index) => {
                if (index === selectedDropdownIndex) {
                    option.classList.add('bg-blue-50', 'dark:bg-blue-900');
                    option.scrollIntoView({ block: 'nearest' });
                } else {
                    option.classList.remove('bg-blue-50', 'dark:bg-blue-900');
                }
            });
        }

        function selectMainProduct(productId, productName) {
            // Clear search
            document.getElementById('mainProductSearch').value = '';
            document.getElementById('mainProductDropdown').classList.add('hidden');
            selectedDropdownIndex = -1;
            
            // Add product to invoice items
            const newRow = addInvoiceItem(productName, productId);
            
            // Focus on quantity input
            const quantityInput = newRow.querySelector('.quantity-input');
            setTimeout(() => {
                quantityInput.focus();
                quantityInput.select();
            }, 100);
            
            // Set current focused row for navigation
            currentFocusedRow = newRow;
        }

        function searchProducts(input) {
            const searchTerm = input.value.toLowerCase().trim();
            const dropdown = input.nextElementSibling;
            
            if (searchTerm.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }
            
            // Enhanced search - match products that start with or contain the search term
            const filteredProducts = products.filter(product => {
                const productName = product.name.toLowerCase();
                
                // Check if product name starts with search term
                if (productName.startsWith(searchTerm)) {
                    return true;
                }
                
                // Check if any word in product name starts with search term
                const productWords = productName.split(' ');
                if (productWords.some(word => word.startsWith(searchTerm))) {
                    return true;
                }
                
                // Check if product name contains the search term anywhere
                return productName.includes(searchTerm);
            });
            
            // Sort results: exact matches first, then starts with, then contains
            filteredProducts.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                
                // Exact match priority
                if (aName === searchTerm && bName !== searchTerm) return -1;
                if (bName === searchTerm && aName !== searchTerm) return 1;
                
                // Starts with priority
                if (aName.startsWith(searchTerm) && !bName.startsWith(searchTerm)) return -1;
                if (bName.startsWith(searchTerm) && !aName.startsWith(searchTerm)) return 1;
                
                // Word starts with priority
                const aWordStarts = aName.split(' ').some(word => word.startsWith(searchTerm));
                const bWordStarts = bName.split(' ').some(word => word.startsWith(searchTerm));
                if (aWordStarts && !bWordStarts) return -1;
                if (bWordStarts && !aWordStarts) return 1;
                
                // Alphabetical order for same priority
                return aName.localeCompare(bName);
            });
            
            if (filteredProducts.length > 0) {
                dropdown.innerHTML = filteredProducts.map(product => {
                    const highlightedName = highlightSearchTerm(product.name, searchTerm);
                    return `
                        <div class="px-3 py-2 hover:bg-blue-50 dark:hover:bg-blue-900 cursor-pointer text-sm border-b border-gray-200 dark:border-gray-600 transition-colors duration-150" onclick="selectProduct(this, ${product.id}, '${product.name.replace(/'/g, "\\'")}', 0)">
                            <div class="font-medium text-gray-900 dark:text-white">${highlightedName}</div>
                            <div class="text-gray-500 dark:text-gray-400 text-xs">
                                <span class="inline-block mr-3">Stock: ${product.stock}</span>
                                <span class="text-orange-600 dark:text-orange-400 font-medium">Price: Manual Entry Required</span>
                            </div>
                        </div>
                    `;
                }).join('');
                dropdown.classList.remove('hidden');
            } else {
                dropdown.innerHTML = `
                    <div class="px-3 py-2 text-sm text-gray-500 dark:text-gray-400 text-center">
                        <i class="fas fa-search mr-2"></i>No products found for "${searchTerm}"
                        <div class="text-xs mt-1">Try searching with different keywords</div>
                    </div>
                `;
                dropdown.classList.remove('hidden');
            }
        }
        
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">$1</mark>');
        }

        function showProductDropdown(input) {
            if (input.value.length > 0) {
                searchProducts(input);
            } else {
                // Show all products when focused with empty input
                const dropdown = input.nextElementSibling;
                dropdown.innerHTML = products.map(product => `
                    <div class="px-3 py-2 hover:bg-blue-50 dark:hover:bg-blue-900 cursor-pointer text-sm border-b border-gray-200 dark:border-gray-600 transition-colors duration-150" onclick="selectProduct(this, ${product.id}, '${product.name.replace(/'/g, "\\'")}', 0)">
                        <div class="font-medium text-gray-900 dark:text-white">${product.name}</div>
                        <div class="text-gray-500 dark:text-gray-400 text-xs">Stock: ${product.stock} - Price: Manual Entry Required</div>
                    </div>
                `).join('');
                dropdown.classList.remove('hidden');
            }
        }

        function handleTableNavigation(event, currentInput) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const row = currentInput.closest('tr');
                
                // Check if current input is quantity
                if (currentInput.classList.contains('quantity-input')) {
                    const priceInput = row.querySelector('.price-input');
                    priceInput.focus();
                    priceInput.select();
                } 
                // Check if current input is price
                else if (currentInput.classList.contains('price-input')) {
                    // After price, go back to main search to add another product
                    const mainSearch = document.getElementById('mainProductSearch');
                    mainSearch.focus();
                    mainSearch.select();
                    
                    // Show dropdown for quick selection
                    showMainProductDropdown(mainSearch);
                }
            }
            
            // Handle arrow key navigation between rows
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                const currentRow = currentInput.closest('tr');
                const allRows = Array.from(document.querySelectorAll('#invoiceItems tr'));
                const currentRowIndex = allRows.indexOf(currentRow);
                
                let targetRow;
                if (event.key === 'ArrowUp' && currentRowIndex > 0) {
                    targetRow = allRows[currentRowIndex - 1];
                } else if (event.key === 'ArrowDown' && currentRowIndex < allRows.length - 1) {
                    targetRow = allRows[currentRowIndex + 1];
                }
                
                if (targetRow) {
                    const targetInput = currentInput.classList.contains('quantity-input') 
                        ? targetRow.querySelector('.quantity-input')
                        : targetRow.querySelector('.price-input');
                    
                    if (targetInput && !targetInput.disabled) {
                        targetInput.focus();
                        targetInput.select();
                    }
                }
            }
        }

        function showProductDropdown(input) {
            const dropdown = input.nextElementSibling;
            
            if (input.value.length > 0) {
                searchProducts(input);
            } else {
                showAllProducts(dropdown);
            }
        }

        function selectProduct(element, productId, productName, productPrice) {
            const row = element.closest('tr');
            const searchInput = row.querySelector('.product-search');
            const priceInput = row.querySelector('.price-input');
            const hiddenInput = row.querySelector('.selected-product-id');
            const dropdown = row.querySelector('.product-dropdown');
            
            searchInput.value = productName;
            priceInput.value = productPrice; // Will be 0, requiring manual entry
            hiddenInput.value = productId;
            dropdown.classList.add('hidden');
            
            // Focus on price input for manual entry
            priceInput.focus();
            priceInput.select();
            
            updateItemAmount(row.querySelector('.quantity-input'));
        }

        function updateItemAmount(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const amount = quantity * price;
            
            row.querySelector('.amount-display').textContent = '৳' + amount.toFixed(2);
            calculateInvoiceTotal();
        }

        function removeInvoiceItem(button) {
            button.closest('tr').remove();
            calculateInvoiceTotal();
        }

        function calculateInvoiceTotal() {
            const amounts = Array.from(document.querySelectorAll('.amount-display'))
                .map(span => parseFloat(span.textContent.replace('৳', '')) || 0);
            
            const subtotal = amounts.reduce((sum, amount) => sum + amount, 0);
            const adjustmentAmount = parseFloat(document.getElementById('adjustmentAmount').value) || 0;
            const adjustmentType = document.getElementById('adjustmentType').value;
            
            let total = subtotal;
            if (adjustmentType === 'add') {
                total = subtotal + adjustmentAmount;
            } else {
                total = subtotal - adjustmentAmount;
            }
            
            document.getElementById('invoiceTotal').textContent = '৳' + total.toFixed(2);
        }

        function handleCreateInvoice(e) {
            e.preventDefault();
            
            const customerId = parseInt(document.getElementById('selectedCustomerId').value);
            const customer = customers.find(c => c.id === customerId);
            const date = document.getElementById('invoiceDate').value;
            
            if (!customerId || !customer) {
                alert('Please select a customer.');
                return;
            }
            
            // Collect invoice items from the new structure
            const items = [];
            const rows = document.querySelectorAll('#invoiceItems tr');
            
            rows.forEach((row, index) => {
                const productNameElement = row.querySelector('.selected-product-name');
                const quantityInput = row.querySelector('.quantity-input');
                const priceInput = row.querySelector('.price-input');
                
                if (productNameElement && quantityInput && priceInput) {
                    const productName = productNameElement.value || row.querySelector('td:nth-child(2) div').textContent;
                    const quantity = parseFloat(quantityInput.value);
                    const price = parseFloat(priceInput.value);
                    
                    if (productName && productName !== 'Select from search above' && quantity && price) {
                        items.push({
                            serial: index + 1,
                            productName: productName,
                            quantity: quantity,
                            price: price,
                            amount: quantity * price
                        });
                    }
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item to the invoice.');
                return;
            }
            
            const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
            const adjustmentAmount = parseFloat(document.getElementById('adjustmentAmount').value) || 0;
            const adjustmentType = document.getElementById('adjustmentType').value;
            const adjustmentDescription = document.getElementById('adjustmentDescription').value || '';
            
            let total = subtotal;
            if (adjustmentType === 'add') {
                total = subtotal + adjustmentAmount;
            } else {
                total = subtotal - adjustmentAmount;
            }
            
            if (editingItem && editingItem.type === 'invoice') {
                // Update existing invoice
                const invoiceIndex = invoices.findIndex(inv => inv.id === editingItem.id);
                if (invoiceIndex !== -1) {
                    const existingInvoice = invoices[invoiceIndex];
                    invoices[invoiceIndex] = {
                        ...existingInvoice,
                        customerId: customerId,
                        customerName: customer.name,
                        customerInfo: customer,
                        date: date,
                        items: items,
                        subtotal: subtotal,
                        adjustment: {
                            type: adjustmentType,
                            description: adjustmentDescription,
                            amount: adjustmentAmount
                        },
                        total: total
                    };
                    showNotification('Invoice updated successfully!', 'success');
                }
                editingItem = null;
            } else {
                // Create new invoice
                const newInvoice = {
                    id: Date.now(),
                    number: 'INV-' + new Date().getFullYear() + '-' + String(invoices.length + 1).padStart(3, '0'),
                    customerId: customerId,
                    customerName: customer.name,
                    customerInfo: customer,
                    date: date,
                    items: items,
                    subtotal: subtotal,
                    adjustment: {
                        type: adjustmentType,
                        description: adjustmentDescription,
                        amount: adjustmentAmount
                    },
                    total: total
                };
                
                invoices.push(newInvoice);
                showNotification('Invoice created successfully!', 'success');
            }
            
            saveAllData();
            loadInvoices();
            closeModal('createInvoiceModal');
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;
            
            generateInvoicePreview(invoice);
            document.getElementById('invoicePreviewModal').classList.remove('hidden');
        }

        function generateInvoicePreview(invoice) {
            const content = document.getElementById('invoicePreviewContent');
            const logoHtml = companyLogo ? `<img src="${companyLogo}" alt="Company Logo" style="height: 48px; width: auto; object-fit: contain;">` : `<div style="height: 48px; width: 64px; background: #f3f4f6; border-radius: 4px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-building" style="color: #9ca3af;"></i></div>`;
            
            // Calculate reserved space for up to 30 rows
            const maxRows = 30;
            const rowHeight = 24; // Height per row in pixels
            const tableHeaderHeight = 32;
            const reservedTableHeight = tableHeaderHeight + (maxRows * rowHeight);
            
            // Generate table rows - only show filled rows but reserve space for 30
            let tableContent = '';
            if (invoice.items && invoice.items.length > 0) {
                const tableRows = invoice.items.map((item, index) => `
                    <tr style="height: ${rowHeight}px; page-break-inside: avoid; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                        <td style="border: 1px solid #333; padding: 6px 8px; text-align: center; font-weight: 600; vertical-align: middle;">${item.serial}</td>
                        <td style="border: 1px solid #333; padding: 6px 8px; text-align: left; color: #000; vertical-align: middle;">${item.productName}</td>
                        <td style="border: 1px solid #333; padding: 6px 8px; text-align: center; font-weight: 600; vertical-align: middle;">${item.quantity}</td>
                        <td style="border: 1px solid #333; padding: 6px 8px; text-align: right; font-weight: 600; vertical-align: middle;">৳${item.price.toLocaleString()}</td>
                        <td style="border: 1px solid #333; padding: 6px 8px; text-align: right; font-weight: bold; color: #000; vertical-align: middle;">৳${item.amount.toLocaleString()}</td>
                    </tr>
                `).join('');
                
                tableContent = `
                    <div style="margin-bottom: 20px;" class="page-break-inside-avoid">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead style="display: table-header-group;">
                                <tr style="background: #343a40; color: white; height: ${tableHeaderHeight}px;">
                                    <th style="border: 1px solid #333; padding: 8px; text-align: center; font-weight: bold; width: 40px; vertical-align: middle;">#</th>
                                    <th style="border: 1px solid #333; padding: 8px; text-align: left; font-weight: bold; vertical-align: middle;">Product/Service Description</th>
                                    <th style="border: 1px solid #333; padding: 8px; text-align: center; font-weight: bold; width: 60px; vertical-align: middle;">Qty</th>
                                    <th style="border: 1px solid #333; padding: 8px; text-align: right; font-weight: bold; width: 100px; vertical-align: middle;">Unit Price (৳)</th>
                                    <th style="border: 1px solid #333; padding: 8px; text-align: right; font-weight: bold; width: 120px; vertical-align: middle;">Total Amount (৳)</th>
                                </tr>
                            </thead>
                            <tbody style="display: table-row-group;">
                                ${tableRows}
                            </tbody>
                        </table>
                        
                        <!-- Totals Section - Right after table -->
                        <div style="text-align: right; margin-top: 18px;" class="page-break-inside-avoid">
                            <div style="display: inline-block; width: 280px;">
                                <div style="background: #f8f9fa; border: 1px solid #333; font-size: 10px;">
                                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333;">
                                        <span style="font-weight: bold; color: #333;">Subtotal:</span>
                                        <span style="font-weight: 600; color: #000;">৳${invoice.subtotal.toLocaleString()}</span>
                                    </div>
                                    ${invoice.adjustment.description && invoice.adjustment.amount > 0 ? `
                                        <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333;">
                                            <span style="font-weight: bold; color: #333;">${invoice.adjustment.description}:</span>
                                            <span style="font-weight: 600; color: #000;">${invoice.adjustment.type === 'add' ? '+' : '-'}৳${invoice.adjustment.amount.toLocaleString()}</span>
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: #343a40; color: white; font-weight: bold; font-size: 11px;">
                                        <span>Grand Total:</span>
                                        <span>৳${invoice.total.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Section - Right after totals -->
                        <div style="margin-top: 18px;" class="page-break-inside-avoid">
                            <h4 style="font-size: 12px; font-weight: bold; color: #000; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.05em;">Payment Instructions & Terms:</h4>
                            <div style="background: #f8f9fa; padding: 12px; border: 1px solid #333; font-size: 9px; color: #333;">
                                <p style="margin: 0 0 4px 0;">• Payment is due within 30 days from the invoice date</p>
                                <p style="margin: 0 0 4px 0;">• Late payments may incur additional charges as per company policy</p>
                                <p style="margin: 0 0 4px 0;">• All amounts are in Bangladeshi Taka (BDT)</p>
                                <p style="margin: 0 0 4px 0;">• Please reference invoice number ${invoice.number} when making payment</p>
                                <p style="margin: 0;">• For any queries, contact us at ${companyInfo.email} or ${companyInfo.phone}</p>
                            </div>
                        </div>
                        
                        <!-- Signature Section - Right after notes -->
                        <div style="margin-top: 32px;" class="page-break-inside-avoid">
                            <div style="display: block;">
                                <div style="display: inline-block; width: 48%; text-align: center; vertical-align: top; margin-right: 2%;">
                                    <div style="border-top: 2px solid #666; width: 160px; margin: 0 auto 6px auto;"></div>
                                    <p style="font-size: 9px; font-weight: bold; color: #333; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 3px 0;">Customer Signature</p>
                                    <p style="font-size: 8px; color: #666; margin: 0;">Date: _______________</p>
                                </div>
                                <div style="display: inline-block; width: 48%; text-align: center; vertical-align: top;">
                                    <div style="border-top: 2px solid #666; width: 160px; margin: 0 auto 6px auto;"></div>
                                    <p style="font-size: 9px; font-weight: bold; color: #333; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 3px 0;">Authorized Signature</p>
                                    <p style="font-size: 8px; color: #333; margin: 0;">${companyInfo.name}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reserved space for remaining rows to maintain A4 layout -->
                    <div style="height: ${(maxRows - invoice.items.length) * rowHeight}px;"></div>
                `;
            } else {
                // No products - reserve space but don't show table, but show other sections
                tableContent = `
                    <div style="height: ${reservedTableHeight}px; margin-bottom: 20px;"></div>
                    
                    <!-- Totals Section - Even when no products -->
                    <div style="text-align: right; margin-bottom: 18px;" class="page-break-inside-avoid">
                        <div style="display: inline-block; width: 280px;">
                            <div style="background: #f8f9fa; border: 1px solid #333; font-size: 10px;">
                                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333;">
                                    <span style="font-weight: bold; color: #333;">Subtotal:</span>
                                    <span style="font-weight: 600; color: #000;">৳0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 12px; background: #343a40; color: white; font-weight: bold; font-size: 11px;">
                                    <span>Grand Total:</span>
                                    <span>৳0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div style="margin-bottom: 18px;" class="page-break-inside-avoid">
                        <h4 style="font-size: 12px; font-weight: bold; color: #000; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.05em;">Payment Instructions & Terms:</h4>
                        <div style="background: #f8f9fa; padding: 12px; border: 1px solid #333; font-size: 9px; color: #333;">
                            <p style="margin: 0 0 4px 0;">• Payment is due within 30 days from the invoice date</p>
                            <p style="margin: 0 0 4px 0;">• Late payments may incur additional charges as per company policy</p>
                            <p style="margin: 0 0 4px 0;">• All amounts are in Bangladeshi Taka (BDT)</p>
                            <p style="margin: 0 0 4px 0;">• Please reference invoice number ${invoice.number} when making payment</p>
                            <p style="margin: 0;">• For any queries, contact us at ${companyInfo.email} or ${companyInfo.phone}</p>
                        </div>
                    </div>
                    
                    <!-- Signature Section -->
                    <div style="margin: 32px 0 18px 0;" class="page-break-inside-avoid">
                        <div style="display: block;">
                            <div style="display: inline-block; width: 48%; text-align: center; vertical-align: top; margin-right: 2%;">
                                <div style="border-top: 2px solid #666; width: 160px; margin: 0 auto 6px auto;"></div>
                                <p style="font-size: 9px; font-weight: bold; color: #333; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 3px 0;">Customer Signature</p>
                                <p style="font-size: 8px; color: #666; margin: 0;">Date: _______________</p>
                            </div>
                            <div style="display: inline-block; width: 48%; text-align: center; vertical-align: top;">
                                <div style="border-top: 2px solid #666; width: 160px; margin: 0 auto 6px auto;"></div>
                                <p style="font-size: 9px; font-weight: bold; color: #333; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 3px 0;">Authorized Signature</p>
                                <p style="font-size: 8px; color: #333; margin: 0;">${companyInfo.name}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="print-content" style="background: white; color: black; font-family: 'Times New Roman', Times, serif; font-size: 11px; line-height: 1.3; padding: 15mm; width: 210mm; min-height: 297mm; margin: 0 auto; box-sizing: border-box;">
                    <!-- Header Section -->
                    <div class="page-break-inside-avoid" style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #333;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="display: flex; align-items: center;">
                                <div style="margin-right: 12px;">
                                    ${logoHtml}
                                </div>
                                <div>
                                    <h1 style="font-size: 20px; font-weight: bold; color: #000; margin: 0 0 6px 0;">${companyInfo.name}</h1>
                                    <p style="color: #333; font-size: 10px; margin: 0;">${invoiceSettings.headerNote}</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <h2 style="font-size: 18px; font-weight: bold; color: #000; margin: 0 0 6px 0;">INVOICE</h2>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #333;">
                                    <p style="font-size: 10px; font-weight: bold; color: #000; margin: 0 0 3px 0;">Invoice #: ${invoice.number}</p>
                                    <p style="font-size: 10px; color: #333; margin: 0;">Date: ${new Date(invoice.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Company and Customer Information -->
                    <div class="page-break-inside-avoid" style="margin-bottom: 18px;">
                        <div style="display: block;">
                            <div style="display: inline-block; width: 48%; vertical-align: top; margin-right: 2%;">
                                <h3 style="font-size: 12px; font-weight: bold; color: #000; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.05em;">Bill From:</h3>
                                <div style="background: #f8f9fa; padding: 12px; border: 1px solid #333;">
                                    <p style="font-weight: bold; font-size: 12px; color: #000; margin: 0 0 6px 0;">${companyInfo.name}</p>
                                    <p style="color: #333; white-space: pre-line; margin: 0 0 4px 0; font-size: 9px;">${companyInfo.address}</p>
                                    <p style="color: #333; margin: 0 0 3px 0; font-size: 9px;"><span style="font-weight: 600;">Phone:</span> ${companyInfo.phone}</p>
                                    <p style="color: #333; margin: 0 0 3px 0; font-size: 9px;"><span style="font-weight: 600;">Email:</span> ${companyInfo.email}</p>
                                    <p style="color: #333; margin: 0; font-size: 9px;"><span style="font-weight: 600;">Tax ID:</span> ${companyInfo.taxId}</p>
                                </div>
                            </div>
                            <div style="display: inline-block; width: 48%; vertical-align: top;">
                                <h3 style="font-size: 12px; font-weight: bold; color: #000; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.05em;">Bill To:</h3>
                                <div style="background: #f8f9fa; padding: 12px; border: 1px solid #333;">
                                    <p style="font-weight: bold; font-size: 12px; color: #000; margin: 0 0 6px 0;">${invoice.customerInfo.name}</p>
                                    <p style="color: #333; white-space: pre-line; margin: 0 0 4px 0; font-size: 9px;">${invoice.customerInfo.address}</p>
                                    <p style="color: #333; margin: 0 0 3px 0; font-size: 9px;"><span style="font-weight: 600;">Phone:</span> ${invoice.customerInfo.phone}</p>
                                    <p style="color: #333; margin: 0; font-size: 9px;"><span style="font-weight: 600;">Email:</span> ${invoice.customerInfo.email}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Invoice Details -->
                    <div class="page-break-inside-avoid" style="margin-bottom: 16px; background: #f8f9fa; padding: 12px; border: 1px solid #333;">
                        <div style="display: block;">
                            <div style="display: inline-block; width: 32%; vertical-align: top; margin-right: 2%;">
                                <p style="color: #333; margin: 0 0 3px 0; font-size: 9px;"><span style="font-weight: bold; color: #000;">Invoice Date:</span> ${new Date(invoice.date).toLocaleDateString()}</p>
                                <p style="color: #333; margin: 0; font-size: 9px;"><span style="font-weight: bold; color: #000;">Due Date:</span> ${new Date(new Date(invoice.date).getTime() + 30*24*60*60*1000).toLocaleDateString()}</p>
                            </div>
                            <div style="display: inline-block; width: 32%; vertical-align: top; margin-right: 2%;">
                                <p style="color: #333; margin: 0 0 3px 0; font-size: 9px;"><span style="font-weight: bold; color: #000;">Payment Terms:</span> Net 30 Days</p>
                                <p style="color: #333; margin: 0; font-size: 9px;"><span style="font-weight: bold; color: #000;">Currency:</span> BDT (৳)</p>
                            </div>
                            <div style="display: inline-block; width: 32%; vertical-align: top; text-align: right;">
                                <div style="background: white; border: 2px solid #333; padding: 8px;">
                                    <p style="font-size: 9px; font-weight: bold; color: #333; text-transform: uppercase; margin: 0 0 3px 0;">Total Amount</p>
                                    <p style="font-size: 16px; font-weight: bold; color: #000; margin: 0;">৳${invoice.total.toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Items Table with all sections below -->
                    ${tableContent}
                    
                    <!-- Footer -->
                    <div style="text-align: center; border-top: 1px solid #333; padding-top: 12px; margin-top: 16px;" class="page-break-inside-avoid">
                        <p style="font-size: 9px; font-weight: bold; color: #333; margin: 0 0 3px 0;">${invoiceSettings.footerNote}</p>
                        <p style="font-size: 8px; color: #666; margin: 0 0 3px 0;">This is a computer-generated invoice. Thank you for your business!</p>
                        <p style="font-size: 8px; color: #666; margin: 0;">${companyInfo.email} | ${companyInfo.phone}</p>
                    </div>
                </div>
            `;
        }

        function printInvoice() {
            window.print();
        }

        function downloadInvoicePDF() {
            const invoiceContent = document.querySelector('.print-content');
            if (!invoiceContent) {
                showNotification('No invoice content found to download', 'error');
                return;
            }

            // Show loading notification
            showNotification('Generating PDF... Please wait.', 'info');

            // Get invoice number for filename
            const invoiceNumber = invoiceContent.querySelector('h2')?.textContent || 'INVOICE';
            const filename = `${invoiceNumber.replace(/\s+/g, '-').toLowerCase()}.pdf`;

            // Configure html2canvas options for high quality
            const options = {
                scale: 2, // Higher resolution
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: 794, // A4 width in pixels at 96 DPI
                height: 1123, // A4 height in pixels at 96 DPI
                scrollX: 0,
                scrollY: 0,
                windowWidth: 794,
                windowHeight: 1123,
                onclone: function(clonedDoc) {
                    // Ensure proper styling in cloned document
                    const clonedContent = clonedDoc.querySelector('.print-content');
                    if (clonedContent) {
                        clonedContent.style.width = '794px';
                        clonedContent.style.minHeight = '1123px';
                        clonedContent.style.padding = '40px';
                        clonedContent.style.fontFamily = 'Times New Roman, Times, serif';
                        clonedContent.style.fontSize = '12px';
                        clonedContent.style.lineHeight = '1.4';
                        clonedContent.style.color = '#000';
                        clonedContent.style.backgroundColor = '#fff';
                        
                        // Ensure tables are properly styled
                        const tables = clonedContent.querySelectorAll('table');
                        tables.forEach(table => {
                            table.style.borderCollapse = 'collapse';
                            table.style.width = '100%';
                            table.style.fontSize = '11px';
                        });
                        
                        const cells = clonedContent.querySelectorAll('th, td');
                        cells.forEach(cell => {
                            cell.style.border = '1px solid #333';
                            cell.style.padding = '8px';
                        });
                        
                        const headers = clonedContent.querySelectorAll('th');
                        headers.forEach(header => {
                            header.style.backgroundColor = '#343a40';
                            header.style.color = 'white';
                            header.style.fontWeight = 'bold';
                        });
                    }
                }
            };

            // Generate canvas from HTML
            html2canvas(invoiceContent, options).then(canvas => {
                try {
                    // Initialize jsPDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4',
                        compress: true
                    });

                    // A4 dimensions in mm
                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 10;
                    const contentWidth = pageWidth - (margin * 2);
                    const contentHeight = pageHeight - (margin * 2);

                    // Calculate image dimensions
                    const imgWidth = contentWidth;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    // Convert canvas to image
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);

                    // Check if content fits on one page
                    if (imgHeight <= contentHeight) {
                        // Single page
                        pdf.addImage(imgData, 'JPEG', margin, margin, imgWidth, imgHeight);
                    } else {
                        // Multiple pages needed
                        let yPosition = 0;
                        let pageNumber = 1;

                        while (yPosition < imgHeight) {
                            if (pageNumber > 1) {
                                pdf.addPage();
                            }

                            const sourceY = yPosition * (canvas.height / imgHeight);
                            const sourceHeight = Math.min(contentHeight * (canvas.height / imgHeight), canvas.height - sourceY);
                            
                            // Create a temporary canvas for this page
                            const pageCanvas = document.createElement('canvas');
                            const pageCtx = pageCanvas.getContext('2d');
                            pageCanvas.width = canvas.width;
                            pageCanvas.height = sourceHeight;
                            
                            pageCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
                            
                            const pageImgData = pageCanvas.toDataURL('image/jpeg', 0.95);
                            const pageImgHeight = (sourceHeight * imgWidth) / canvas.width;
                            
                            pdf.addImage(pageImgData, 'JPEG', margin, margin, imgWidth, pageImgHeight);
                            
                            yPosition += contentHeight;
                            pageNumber++;
                        }
                    }

                    // Add metadata
                    pdf.setProperties({
                        title: invoiceNumber,
                        subject: 'Invoice',
                        author: companyInfo.name,
                        creator: 'Sayed\'s Lamp Business Management System',
                        producer: 'Sayed\'s Lamp Business Management System'
                    });

                    // Save the PDF
                    pdf.save(filename);
                    
                    showNotification('PDF downloaded successfully!', 'success');
                    
                } catch (error) {
                    console.error('PDF generation error:', error);
                    showNotification('PDF generation failed: ' + error.message, 'error');
                    
                    // Fallback to print dialog
                    showNotification('Falling back to print dialog...', 'info');
                    setTimeout(() => {
                        window.print();
                    }, 1000);
                }
            }).catch(error => {
                console.error('Canvas generation error:', error);
                showNotification('Failed to generate PDF: ' + error.message, 'error');
                
                // Fallback to print dialog
                showNotification('Falling back to print dialog...', 'info');
                setTimeout(() => {
                    window.print();
                }, 1000);
            });
        }

        function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                invoices = invoices.filter(invoice => invoice.id !== id);
                saveAllData();
                loadInvoices();
                showNotification('Invoice deleted successfully!', 'success');
            }
        }

        // User Management Functions
        function handleUpdateCredentials(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newUsername = document.getElementById('adminUsername').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate current password
            if (currentPassword !== userCredentials.password) {
                showNotification('Current password is incorrect!', 'error');
                return;
            }
            
            // Validate new password confirmation
            if (newPassword && newPassword !== confirmPassword) {
                showNotification('New passwords do not match!', 'error');
                return;
            }
            
            // Update credentials
            userCredentials.username = newUsername || userCredentials.username;
            if (newPassword) {
                userCredentials.password = newPassword;
            }
            
            // Save to localStorage
            localStorage.setItem('dealership_userCredentials', JSON.stringify(userCredentials));
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('User credentials updated successfully!', 'success');
        }

        // Settings functions
        function loadSettings() {
            // Load user credentials
            document.getElementById('adminUsername').value = userCredentials.username;
            
            // Update login page credentials display
            document.getElementById('defaultCredentials').textContent = `${userCredentials.username} / ${userCredentials.password}`;
            
            document.getElementById('companyName').value = companyInfo.name;
            document.getElementById('companyAddress').value = companyInfo.address;
            document.getElementById('companyPhone').value = companyInfo.phone;
            document.getElementById('companyEmail').value = companyInfo.email;
            document.getElementById('companyTaxId').value = companyInfo.taxId;
            
            document.getElementById('invoiceHeaderNote').value = invoiceSettings.headerNote;
            document.getElementById('invoiceFooterNote').value = invoiceSettings.footerNote;
            document.getElementById('invoiceColor').value = invoiceSettings.color;
            
            if (companyLogo) {
                document.getElementById('logoPreview').innerHTML = `<img src="${companyLogo}" alt="Company Logo" class="w-full h-full object-contain rounded">`;
            }
        }

        function loadCompanyInfo() {
            if (companyLogo) {
                document.getElementById('logoPreview').innerHTML = `<img src="${companyLogo}" alt="Company Logo" class="w-full h-full object-contain rounded">`;
            }
        }

        function handleSaveCompanyInfo(e) {
            e.preventDefault();
            
            const phone = document.getElementById('companyPhone').value;
            if (phone && (!phone.startsWith('880') || phone.length !== 13)) {
                alert('Please enter a valid Bangladesh phone number (880XXXXXXXXX)');
                return;
            }
            
            companyInfo = {
                name: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value,
                phone: phone,
                email: document.getElementById('companyEmail').value,
                taxId: document.getElementById('companyTaxId').value
            };
            
            saveAllData();
            showNotification('Company information saved successfully!', 'success');
        }

        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showNotification('Please select a valid image file (JPG, PNG, GIF, WebP)', 'error');
                e.target.value = ''; // Clear the input
                return;
            }
            
            // Validate file size (2MB limit)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('Please select an image smaller than 2MB', 'error');
                e.target.value = ''; // Clear the input
                return;
            }
            
            showNotification('Processing logo...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(readerEvent) {
                try {
                    const logoData = readerEvent.target.result;
                    
                    // Validate the data URL
                    if (!logoData || !logoData.startsWith('data:image/')) {
                        throw new Error('Invalid image data');
                    }
                    
                    // Create an image element to validate the image loads properly
                    const testImg = new Image();
                    testImg.onload = function() {
                        try {
                            // Image loaded successfully, now save it
                            companyLogo = logoData;
                            
                            // Update preview immediately
                            const logoPreview = document.getElementById('logoPreview');
                            if (logoPreview) {
                                logoPreview.innerHTML = `<img src="${logoData}" alt="Company Logo" class="w-full h-full object-contain rounded">`;
                            }
                            
                            // Save to localStorage
                            try {
                                localStorage.setItem('dealership_companyLogo', logoData);
                                
                                // Verify the save was successful
                                const savedLogo = localStorage.getItem('dealership_companyLogo');
                                if (savedLogo && savedLogo.length > 100) { // Basic validation
                                    showNotification('Logo uploaded and saved successfully!', 'success');
                                    
                                    // Also save all other data
                                    saveAllData();
                                    
                                    // Clear the file input for next use
                                    e.target.value = '';
                                } else {
                                    throw new Error('Logo save verification failed');
                                }
                            } catch (storageError) {
                                console.error('Storage error:', storageError);
                                
                                // Check if it's a quota exceeded error
                                if (storageError.name === 'QuotaExceededError' || storageError.code === 22) {
                                    showNotification('Storage quota exceeded. Please try a smaller image or clear browser data.', 'error');
                                } else {
                                    showNotification('Failed to save logo. Please try again.', 'error');
                                }
                                
                                // Reset logo
                                companyLogo = null;
                                const logoPreview = document.getElementById('logoPreview');
                                if (logoPreview) {
                                    logoPreview.innerHTML = '<i class="fas fa-image text-gray-400 text-3xl"></i>';
                                }
                            }
                        } catch (error) {
                            console.error('Logo save error:', error);
                            showNotification('Failed to save logo: ' + error.message, 'error');
                        }
                    };
                    
                    testImg.onerror = function() {
                        showNotification('Invalid or corrupted image file. Please try another image.', 'error');
                        e.target.value = '';
                    };
                    
                    // Start loading the image to validate it
                    testImg.src = logoData;
                    
                } catch (error) {
                    console.error('Logo processing error:', error);
                    showNotification('Failed to process logo: ' + error.message, 'error');
                    e.target.value = '';
                }
            };
            
            reader.onerror = function() {
                showNotification('Failed to read the image file', 'error');
                e.target.value = '';
            };
            
            reader.readAsDataURL(file);
        }

        function saveInvoiceSettings() {
            invoiceSettings = {
                headerNote: document.getElementById('invoiceHeaderNote').value || 'Thank you for your business!',
                footerNote: document.getElementById('invoiceFooterNote').value || 'Payment due within 30 days',
                color: document.getElementById('invoiceColor').value || '#2563eb'
            };
            
            localStorage.setItem('dealership_invoiceSettings', JSON.stringify(invoiceSettings));
            showNotification('Invoice template settings saved successfully!', 'success');
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            editingItem = null; // Reset editing state when closing modals
            
            // Reset invoice modal title and button text when closing
            if (modalId === 'createInvoiceModal') {
                document.querySelector('#createInvoiceModal h3').textContent = 'Create Invoice';
                document.querySelector('#createInvoiceForm button[type="submit"]').innerHTML = '<i class="fas fa-plus mr-2"></i>Create Invoice';
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('fixed') && e.target.classList.contains('inset-0')) {
                e.target.classList.add('hidden');
            }
        });

        // Hide dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.product-search') && !e.target.closest('.product-dropdown')) {
                document.querySelectorAll('.product-dropdown').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
            }
            
            if (!e.target.closest('#customerSearch') && !e.target.closest('#customerDropdown')) {
                const customerDropdown = document.getElementById('customerDropdown');
                if (customerDropdown) {
                    customerDropdown.classList.add('hidden');
                }
            }
            
            // Hide main product dropdown when clicking outside
            if (!e.target.closest('#mainProductSearch') && !e.target.closest('#mainProductDropdown')) {
                const mainDropdown = document.getElementById('mainProductDropdown');
                if (mainDropdown) {
                    mainDropdown.classList.add('hidden');
                    selectedDropdownIndex = -1;
                }
            }
        });

        // Responsive sidebar for mobile
        window.addEventListener('resize', function() {
            if (window.innerWidth < 1024 && !sidebarCollapsed) {
                toggleSidebar();
            } else if (window.innerWidth >= 1024 && sidebarCollapsed) {
                toggleSidebar();
            }
        });

        // User Management Functions
        function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">${user.name}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${user.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'}">${user.role}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${user.active ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">${user.active ? 'Active' : 'Inactive'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        ${user.id !== 1 ? `<button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900">Delete</button>` : '<span class="text-gray-400">Protected</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userSubmitBtn').textContent = 'Add User';
            document.getElementById('addUserForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('userActive').checked = true;
            document.getElementById('addUserModal').classList.remove('hidden');
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userSubmitBtn').textContent = 'Update User';
            document.getElementById('editUserId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPassword').value = user.password;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userActive').checked = user.active;
            
            document.getElementById('addUserModal').classList.remove('hidden');
        }

        function deleteUser(id) {
            if (id === 1) {
                showNotification('Cannot delete the main admin user!', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(user => user.id !== id);
                saveAllData();
                loadUsers();
                showNotification('User deleted successfully!', 'success');
            }
        }

        // Edit functions for other entities
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;
            
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productStock').value = product.stock;
            
            editingItem = { type: 'product', id: id };
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerEmail').value = customer.email;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerAddress').value = customer.address;
            
            editingItem = { type: 'customer', id: id };
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;
            
            // Set form to edit mode
            editingItem = { type: 'invoice', id: id };
            
            // Populate customer information
            document.getElementById('customerSearch').value = invoice.customerName;
            document.getElementById('selectedCustomerId').value = invoice.customerId;
            document.getElementById('invoiceDate').value = invoice.date;
            
            // Clear existing items
            document.getElementById('invoiceItems').innerHTML = '';
            
            // Populate invoice items
            invoice.items.forEach((item, index) => {
                addInvoiceItem();
                const row = document.querySelector('#invoiceItems tr:last-child');
                
                row.querySelector('.product-search').value = item.productName;
                row.querySelector('.quantity-input').value = item.quantity;
                row.querySelector('.price-input').value = item.price;
                row.querySelector('.amount-display').textContent = '৳' + item.amount.toFixed(2);
                
                // Update serial number
                row.querySelector('td:first-child').textContent = item.serial;
            });
            
            // Populate adjustment fields
            if (invoice.adjustment) {
                document.getElementById('adjustmentType').value = invoice.adjustment.type || 'add';
                document.getElementById('adjustmentDescription').value = invoice.adjustment.description || '';
                document.getElementById('adjustmentAmount').value = invoice.adjustment.amount || 0;
            }
            
            // Calculate and display total
            calculateInvoiceTotal();
            
            // Change modal title and button text
            document.querySelector('#createInvoiceModal h3').textContent = 'Edit Invoice';
            document.querySelector('#createInvoiceForm button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Update Invoice';
            
            // Show modal
            document.getElementById('createInvoiceModal').classList.remove('hidden');
        }

        function handleAddUser(e) {
            e.preventDefault();
            
            const editId = document.getElementById('editUserId').value;
            const username = document.getElementById('userUsername').value;
            const email = document.getElementById('userEmail').value;
            
            // Check for duplicate username (excluding current user if editing)
            const existingUser = users.find(u => u.username === username && u.id != editId);
            if (existingUser) {
                showNotification('Username already exists!', 'error');
                return;
            }
            
            // Check for duplicate email (excluding current user if editing)
            const existingEmail = users.find(u => u.email === email && u.id != editId);
            if (existingEmail) {
                showNotification('Email already exists!', 'error');
                return;
            }
            
            const userData = {
                name: document.getElementById('userName').value,
                username: username,
                email: email,
                password: document.getElementById('userPassword').value,
                role: document.getElementById('userRole').value,
                active: document.getElementById('userActive').checked
            };
            
            if (editId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.id == editId);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...userData };
                    showNotification('User updated successfully!', 'success');
                }
            } else {
                // Add new user
                const newUser = {
                    id: Date.now(),
                    ...userData,
                    createdAt: new Date().toISOString()
                };
                users.push(newUser);
                showNotification('User added successfully!', 'success');
            }
            
            saveAllData();
            loadUsers();
            closeModal('addUserModal');
            document.getElementById('addUserForm').reset();
        }

        // Export Web App Function
        function exportWebApp() {
            try {
                showNotification('Preparing export... Please wait.', 'info');
                
                // Get current HTML content
                const htmlContent = document.documentElement.outerHTML;
                
                // Escape data for safe embedding
                const escapeForJS = (obj) => {
                    return JSON.stringify(obj).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                };
                
                // Create the complete web app with embedded data
                let exportedApp = htmlContent
                    .replace('let products = [];', `let products = ${escapeForJS(products)};`)
                    .replace('let customers = [];', `let customers = ${escapeForJS(customers)};`)
                    .replace('let invoices = [];', `let invoices = ${escapeForJS(invoices)};`)
                    .replace('let companyInfo = {};', `let companyInfo = ${escapeForJS(companyInfo)};`)
                    .replace('let invoiceSettings = {};', `let invoiceSettings = ${escapeForJS(invoiceSettings)};`)
                    .replace('let companyLogo = null;', `let companyLogo = ${companyLogo ? escapeForJS(companyLogo) : 'null'};`);
                
                // Remove the loadSampleData call since we have real data
                exportedApp = exportedApp.replace('loadSampleData();', '// Sample data removed - using exported data');
                
                // Create filename with timestamp
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                const filename = `dealership-management-system-${timestamp}.html`;
                
                // Multiple download methods for better browser compatibility
                const downloadFile = (content, filename) => {
                    // Method 1: Blob + URL.createObjectURL (modern browsers)
                    try {
                        const blob = new Blob([content], { 
                            type: 'text/html;charset=utf-8' 
                        });
                        
                        // Check if browser supports download attribute
                        const a = document.createElement('a');
                        if ('download' in a) {
                            const url = URL.createObjectURL(blob);
                            a.href = url;
                            a.download = filename;
                            a.style.display = 'none';
                            
                            document.body.appendChild(a);
                            a.click();
                            
                            // Cleanup
                            setTimeout(() => {
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            }, 100);
                            
                            return true;
                        }
                    } catch (e) {
                        console.warn('Blob download failed:', e);
                    }
                    
                    // Method 2: Data URI fallback
                    try {
                        const dataUri = 'data:text/html;charset=utf-8,' + encodeURIComponent(content);
                        const a = document.createElement('a');
                        a.href = dataUri;
                        a.download = filename;
                        a.style.display = 'none';
                        
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        return true;
                    } catch (e) {
                        console.warn('Data URI download failed:', e);
                    }
                    
                    // Method 3: Open in new window as fallback
                    try {
                        const newWindow = window.open();
                        newWindow.document.write(content);
                        newWindow.document.close();
                        
                        // Try to trigger save dialog
                        setTimeout(() => {
                            newWindow.document.title = filename;
                            newWindow.focus();
                        }, 100);
                        
                        showNotification('File opened in new window. Please save it manually (Ctrl+S).', 'info');
                        return true;
                    } catch (e) {
                        console.warn('New window fallback failed:', e);
                    }
                    
                    return false;
                };
                
                // Attempt download
                const success = downloadFile(exportedApp, filename);
                
                if (success) {
                    showNotification('Web app exported successfully! Check your downloads folder.', 'success');
                    
                    // Show instructions after a delay
                    setTimeout(() => {
                        showExportInstructions();
                    }, 1500);
                } else {
                    // Final fallback - show content in textarea for manual copy
                    showManualExportDialog(exportedApp, filename);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed: ' + error.message, 'error');
                
                // Show manual export as fallback
                try {
                    const basicExport = document.documentElement.outerHTML;
                    showManualExportDialog(basicExport, 'dealership-system-backup.html');
                } catch (fallbackError) {
                    showNotification('Critical export error. Please try refreshing the page.', 'error');
                }
            }
        }
        
        function showManualExportDialog(content, filename) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-download text-blue-600 mr-2"></i>
                                Manual Export Required
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4 p-4 bg-yellow-50 dark:bg-yellow-900 rounded-lg border border-yellow-200 dark:border-yellow-700">
                            <p class="text-yellow-800 dark:text-yellow-200 text-sm">
                                <i class="fas fa-info-circle mr-2"></i>
                                Automatic download isn't supported in your browser. Please copy the content below and save it as <strong>${filename}</strong>
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Complete Web Application Code:
                            </label>
                            <textarea id="exportContent" class="w-full h-64 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-xs font-mono dark:bg-gray-700 dark:text-white" readonly>${content}</textarea>
                        </div>
                        
                        <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                            <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">Instructions:</h4>
                            <ol class="text-blue-700 dark:text-blue-300 text-sm space-y-1">
                                <li>1. Click "Copy to Clipboard" button below</li>
                                <li>2. Open a text editor (Notepad, TextEdit, etc.)</li>
                                <li>3. Paste the content (Ctrl+V or Cmd+V)</li>
                                <li>4. Save the file as "${filename}"</li>
                                <li>5. Double-click the saved file to run your app</li>
                            </ol>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="copyExportContent()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function copyExportContent() {
            const textarea = document.getElementById('exportContent');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showNotification('Content copied to clipboard! Now paste it into a text editor and save as HTML.', 'success');
                } else {
                    showNotification('Copy failed. Please select all text manually and copy.', 'error');
                }
            } catch (err) {
                // Fallback for modern browsers
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        showNotification('Content copied to clipboard! Now paste it into a text editor and save as HTML.', 'success');
                    }).catch(() => {
                        showNotification('Copy failed. Please select all text manually and copy.', 'error');
                    });
                } else {
                    showNotification('Please select all text manually and copy (Ctrl+C).', 'info');
                }
            }
        }

        function showExportInstructions() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                Export Instructions
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-4 text-sm text-gray-700 dark:text-gray-300">
                            <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg border border-green-200 dark:border-green-700">
                                <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">
                                    <i class="fas fa-check-circle mr-2"></i>Export Successful!
                                </h4>
                                <p class="text-green-700 dark:text-green-300">Your complete dealership management system has been exported as a standalone HTML file.</p>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-2">
                                    <i class="fas fa-play-circle text-blue-600 mr-2"></i>How to Use:
                                </h4>
                                <ul class="space-y-2 ml-4">
                                    <li class="flex items-start">
                                        <span class="text-blue-600 mr-2">1.</span>
                                        <span>Double-click the downloaded HTML file to open it in your default browser</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-blue-600 mr-2">2.</span>
                                        <span>Or right-click and select "Open with" → your preferred browser</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-blue-600 mr-2">3.</span>
                                        <span>Login with: <code class="bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">admin / admin</code></span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-blue-600 mr-2">4.</span>
                                        <span>All your data (products, customers, invoices) is included and ready to use!</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 dark:text-white mb-2">
                                    <i class="fas fa-server text-green-600 mr-2"></i>Deployment Options:
                                </h4>
                                <ul class="space-y-2 ml-4">
                                    <li class="flex items-start">
                                        <span class="text-green-600 mr-2">•</span>
                                        <span><strong>Local Use:</strong> Run directly from your computer - no internet required</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-600 mr-2">•</span>
                                        <span><strong>Web Hosting:</strong> Upload to any web hosting service (GitHub Pages, Netlify, etc.)</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-600 mr-2">•</span>
                                        <span><strong>Network Sharing:</strong> Place on a shared network drive for team access</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                                <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">
                                    <i class="fas fa-lightbulb mr-2"></i>Features Included:
                                </h4>
                                <div class="grid grid-cols-2 gap-2 text-blue-700 dark:text-blue-300 text-xs">
                                    <div>✓ Complete Dashboard</div>
                                    <div>✓ Product Management</div>
                                    <div>✓ Customer Management</div>
                                    <div>✓ Invoice Generation</div>
                                    <div>✓ Professional Print Layout</div>
                                    <div>✓ Dark/Light Theme</div>
                                    <div>✓ Data Persistence</div>
                                    <div>✓ Responsive Design</div>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg border border-yellow-200 dark:border-yellow-700">
                                <h4 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Important Notes:
                                </h4>
                                <ul class="space-y-1 text-yellow-700 dark:text-yellow-300 text-xs">
                                    <li>• Data is stored locally in the browser - backup regularly</li>
                                    <li>• Works offline - no internet connection required</li>
                                    <li>• Compatible with all modern browsers</li>
                                    <li>• File size includes all your current data</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                Got it!
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96393ae6f63f4ea4',t:'MTc1MzI1MzI4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
